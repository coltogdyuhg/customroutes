import React, { useState, useEffect, useRef } from 'react';
import { 
  Map as MapIcon, 
  Navigation, 
  Smartphone, 
  Monitor, 
  Zap, 
  Plus, 
  X, 
  Save, 
  RotateCcw, 
  Trash2, 
  Search,
  Crosshair
} from 'lucide-react';

/**
 * CustomRoutes - React Edition
 * Fixes: Added Leaflet dependency injection and initialization safety.
 */

export default function App() {
  // --- State Management ---
  const [screen, setScreen] = useState('boot'); 
  const [bootProgress, setBootProgress] = useState(0);
  const [loadProgress, setLoadProgress] = useState(0);
  const [viewMode, setViewMode] = useState('desktop');
  const [isDrawing, setIsDrawing] = useState(false);
  const [routePath, setRoutePath] = useState([]);
  const [savedRoutes, setSavedRoutes] = useState([]);
  const [showSaveModal, setShowSaveModal] = useState(false);
  const [routeNameInput, setRouteNameInput] = useState('');
  const [gpsStatus, setGpsStatus] = useState('standby');
  const [errorToast, setErrorToast] = useState(null);
  const [manualSearch, setManualSearch] = useState('');

  // --- Refs ---
  const mapRef = useRef(null);
  const polylineRef = useRef(null);
  const userMarkerRef = useRef(null);
  const activeViewLineRef = useRef(null);
  const markersRef = useRef([]);

  // Inject Leaflet Styles and Scripts if they don't exist
  useEffect(() => {
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link');
      link.id = 'leaflet-css';
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
    }
    if (!document.getElementById('leaflet-js')) {
      const script = document.createElement('script');
      script.id = 'leaflet-js';
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      document.head.appendChild(script);
    }
  }, []);

  // --- Boot Sequence ---
  useEffect(() => {
    if (screen === 'boot') {
      const interval = setInterval(() => {
        setBootProgress(prev => {
          if (prev >= 100) {
            clearInterval(interval);
            setTimeout(() => setScreen('selection'), 500);
            return 100;
          }
          return prev + Math.random() * 20;
        });
      }, 100);
      return () => clearInterval(interval);
    }
  }, [screen]);

  // --- Loading Sequence ---
  useEffect(() => {
    if (screen === 'loading') {
      const interval = setInterval(() => {
        setLoadProgress(prev => {
          if (prev >= 100) {
            clearInterval(interval);
            setTimeout(() => setScreen('app'), 500);
            return 100;
          }
          return prev + 10;
        });
      }, 50);
      return () => clearInterval(interval);
    }
  }, [screen]);

  // --- Map Initialization ---
  useEffect(() => {
    if (screen === 'app' && !mapRef.current) {
      // Small delay to ensure Leaflet is fully parsed by the browser
      const timer = setTimeout(() => {
        if (typeof window.L === 'undefined') {
          setErrorToast("Map library failed to load. Please refresh.");
          return;
        }

        const L = window.L;
        const fallback = [40.7128, -74.0060];
        
        const map = L.map('map-container', {
          zoomControl: viewMode === 'desktop',
          attributionControl: false,
          tap: true
        }).setView(fallback, 13);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
        
        const polyline = L.polyline([], { 
          color: '#6366f1', 
          weight: 4, 
          dashArray: '5, 10' 
        }).addTo(map);

        const customIcon = L.divIcon({
          className: 'custom-div-icon',
          html: `
            <div class="relative flex items-center justify-center">
              <div class="absolute w-4 h-4 bg-indigo-500/40 rounded-full animate-ping"></div>
              <div class="relative w-3.5 h-3.5 bg-indigo-600 border-2 border-white rounded-full shadow-md"></div>
            </div>
          `,
          iconSize: [14, 14],
          iconAnchor: [7, 7]
        });

        const userMarker = L.marker(fallback, { icon: customIcon }).addTo(map);

        mapRef.current = map;
        polylineRef.current = polyline;
        userMarkerRef.current = userMarker;

        // GPS Logic
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const latlng = [pos.coords.latitude, pos.coords.longitude];
              userMarker.setLatLng(latlng);
              setGpsStatus('connected');
              map.flyTo(latlng, 15);
            },
            () => setGpsStatus('offline'),
            { enableHighAccuracy: true, timeout: 5000 }
          );
        } else {
          setGpsStatus('offline');
        }

        // Map Click Handling
        map.on('click', (e) => {
          if (map.getContainer().style.cursor === 'crosshair') {
            const pt = [e.latlng.lat, e.latlng.lng];
            setRoutePath(prev => {
              const newPath = [...prev, pt];
              polyline.setLatLngs(newPath);
              return newPath;
            });
            
            const m = L.circleMarker(pt, { 
              radius: 5, 
              fillColor: '#4f46e5', 
              color: '#fff', 
              weight: 2, 
              fillOpacity: 1 
            }).addTo(map);
            markersRef.current.push(m);
          }
        });
      }, 100);

      return () => {
        clearTimeout(timer);
        if (mapRef.current) {
          mapRef.current.remove();
          mapRef.current = null;
        }
      };
    }
  }, [screen, viewMode]);

  const handleManualSearch = async () => {
    if (!manualSearch || !mapRef.current) return;
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(manualSearch)}`);
      const data = await res.json();
      if (data.length > 0) {
        const latlng = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
        if (userMarkerRef.current) userMarkerRef.current.setLatLng(latlng);
        mapRef.current.flyTo(latlng, 15);
        setGpsStatus('connected');
      }
    } catch (e) {
      console.error(e);
    }
  };

  const startDrawing = () => {
    resetDrawing();
    setIsDrawing(true);
    if (mapRef.current) mapRef.current.getContainer().style.cursor = 'crosshair';
  };

  const resetDrawing = () => {
    setIsDrawing(false);
    setRoutePath([]);
    if (polylineRef.current) polylineRef.current.setLatLngs([]);
    markersRef.current.forEach(m => mapRef.current?.removeLayer(m));
    markersRef.current = [];
    if (mapRef.current) mapRef.current.getContainer().style.cursor = '';
    if (activeViewLineRef.current) {
      mapRef.current?.removeLayer(activeViewLineRef.current);
      activeViewLineRef.current = null;
    }
  };

  const saveRoute = () => {
    const name = routeNameInput.trim() || `Path ${new Date().toLocaleTimeString()}`;
    const newRoute = {
      id: Date.now(),
      name,
      path: [...routePath],
      timestamp: new Date().toLocaleTimeString()
    };
    setSavedRoutes(prev => [newRoute, ...prev]);
    if (mapRef.current && window.L) {
      window.L.polyline(newRoute.path, { color: '#6366f1', weight: 2, opacity: 0.2 }).addTo(mapRef.current);
    }
    setShowSaveModal(false);
    setRouteNameInput('');
    resetDrawing();
  };

  const viewRoute = (route) => {
    if (!mapRef.current || !window.L) return;
    if (activeViewLineRef.current) mapRef.current.removeLayer(activeViewLineRef.current);
    activeViewLineRef.current = window.L.polyline(route.path, {
      color: '#4338ca',
      weight: 6,
      opacity: 0.9,
      lineJoin: 'round',
      lineCap: 'round'
    }).addTo(mapRef.current);
    mapRef.current.fitBounds(window.L.latLngBounds(route.path), { padding: [50, 50] });
  };

  if (screen === 'boot') {
    return (
      <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
        <div className="max-w-md w-full space-y-8">
          <div className="w-16 h-16 bg-indigo-600 rounded-2xl mx-auto flex items-center justify-center shadow-2xl animate-bounce">
            <Navigation className="text-white w-8 h-8" />
          </div>
          <h2 className="text-3xl font-black text-white italic uppercase tracking-tighter">CustomRoutes</h2>
          <div className="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
            <div className="h-full bg-indigo-500 transition-all duration-200" style={{ width: `${bootProgress}%` }}></div>
          </div>
        </div>
      </div>
    );
  }

  if (screen === 'selection') {
    return (
      <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center p-6">
        <h1 className="text-3xl font-black text-white italic uppercase mb-10">Select Mode</h1>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-xl">
          <button onClick={() => { setViewMode('desktop'); setScreen('loading'); }} className="p-8 bg-white/5 border border-white/10 rounded-3xl hover:bg-white/10 transition-all flex flex-col items-center gap-4 group">
            <Monitor size={48} className="text-indigo-400 group-hover:scale-110 transition-transform" />
            <span className="text-white font-bold uppercase text-xs tracking-widest">Desktop</span>
          </button>
          <button onClick={() => { setViewMode('mobile'); setScreen('loading'); }} className="p-8 bg-white/5 border border-white/10 rounded-3xl hover:bg-white/10 transition-all flex flex-col items-center gap-4 group">
            <Smartphone size={48} className="text-pink-400 group-hover:scale-110 transition-transform" />
            <span className="text-white font-bold uppercase text-xs tracking-widest">Mobile</span>
          </button>
        </div>
      </div>
    );
  }

  if (screen === 'loading') {
    return (
      <div className="fixed inset-0 bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
        <h2 className="text-2xl font-black text-white italic uppercase mb-4">Syncing Map</h2>
        <div className="w-full max-w-xs bg-white/5 h-2 rounded-full overflow-hidden">
          <div className="h-full bg-gradient-to-r from-indigo-500 to-pink-500 transition-all duration-300" style={{ width: `${loadProgress}%` }}></div>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col h-screen bg-slate-50">
      {showSaveModal && (
        <div className="fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-slate-950/60 backdrop-blur-sm">
          <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl space-y-6">
            <h3 className="text-xl font-black italic uppercase">Name Route</h3>
            <input value={routeNameInput} onChange={(e) => setRouteNameInput(e.target.value)} placeholder="Route Name" className="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 ring-indigo-500" />
            <div className="flex gap-3">
              <button onClick={saveRoute} className="flex-grow bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-[10px]">Save</button>
              <button onClick={() => setShowSaveModal(false)} className="px-6 bg-slate-100 text-slate-400 py-4 rounded-2xl font-black uppercase text-[10px]">Back</button>
            </div>
          </div>
        </div>
      )}

      <header className="h-16 bg-indigo-600 flex items-center justify-between px-6 shadow-lg z-50">
        <h1 className="text-white font-black italic uppercase tracking-tighter">CustomRoutes</h1>
        <button onClick={() => setScreen('boot')} className="text-white/60 hover:text-white transition-colors"><RotateCcw size={18} /></button>
      </header>

      <main className={`flex flex-grow overflow-hidden ${viewMode === 'mobile' ? 'flex-col' : ''}`}>
        <aside className={`${viewMode === 'desktop' ? 'w-80 border-r' : 'w-full h-1/2 border-t'} bg-white flex flex-col z-40`}>
          <div className="p-5 space-y-4 border-b">
            {gpsStatus === 'offline' && (
              <div className="flex gap-2">
                <input value={manualSearch} onChange={(e) => setManualSearch(e.target.value)} placeholder="Search location..." className="flex-grow p-2 bg-slate-50 border rounded-xl text-xs" />
                <button onClick={handleManualSearch} className="px-3 bg-indigo-600 text-white rounded-xl text-[10px] font-bold">GO</button>
              </div>
            )}
            {!isDrawing ? (
              <button onClick={startDrawing} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest flex items-center justify-center gap-2">
                <Plus size={16} /> New Route
              </button>
            ) : (
              <div className="bg-indigo-50 border-2 border-indigo-100 p-4 rounded-2xl space-y-3">
                <span className="text-[10px] font-black text-indigo-600 uppercase block text-center">{routePath.length} Points</span>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={() => setShowSaveModal(true)} disabled={routePath.length < 2} className="bg-emerald-500 text-white py-3 rounded-xl font-black text-[10px] uppercase disabled:opacity-50">Save</button>
                  <button onClick={resetDrawing} className="bg-white text-rose-500 py-3 rounded-xl font-black text-[10px] uppercase border">Cancel</button>
                </div>
              </div>
            )}
          </div>
          <div className="flex-1 overflow-y-auto p-5">
            <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Saved Paths</h3>
            <div className="space-y-3">
              {savedRoutes.map(route => (
                <div key={route.id} className="bg-white border p-4 rounded-2xl shadow-sm hover:shadow-md transition-all">
                  <div className="flex justify-between items-center">
                    <span className="text-[10px] font-black uppercase truncate w-32">{route.name}</span>
                    <button onClick={() => viewRoute(route)} className="text-indigo-600 font-black text-[10px]">VIEW</button>
                    <button onClick={() => deleteRoute(route.id)} className="text-rose-400"><Trash2 size={14} /></button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </aside>

        <div className="flex-grow relative bg-slate-900">
          <div id="map-container" className="absolute inset-0 z-10" />
          {gpsStatus === 'connected' && (
            <button onClick={() => mapRef.current?.flyTo(userMarkerRef.current?.getLatLng(), 16)} className="absolute bottom-6 right-6 z-20 bg-white w-12 h-12 rounded-full shadow-xl flex items-center justify-center text-indigo-600">
              <Crosshair size={20} />
            </button>
          )}
        </div>
      </main>

      <style>{`
        .leaflet-container { background: #0f172a !important; width: 100%; height: 100%; }
        .custom-div-icon { background: transparent !important; border: none !important; }
      `}</style>
    </div>
  );
}
